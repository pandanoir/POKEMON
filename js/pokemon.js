var testMode=!1,doesEncount=!0,IntervalTime=50;window.addEventListener("load",function(){function C(a,b,c){var e=location.pathname,l=[],l=e.split("/");""!=l[l.length-1]&&(l[l.length-1]="",e=l.join("/"));l=(new Date).getTime();l=(new Date(l+864E5*c)).toUTCString();a=""+(a+"="+escape(b));a+="; path="+e;document.cookie=c?a+("; expires="+l+"; "):a+"; "}var x="ontouchstart"in window,f=document.getElementById("map").style;f.left=f.top="0px";var h="title",b={chara:document.getElementById("chara").getContext("2d"),map:document.getElementById("map").getContext("2d"),battle:document.getElementById("battle").getContext("2d"),menu:document.getElementById("menu").getContext("2d"),enemy:document.getElementById("enemy").getContext("2d"),shop:document.getElementById("shop").getContext("2d"),setting:document.getElementById("setting").getContext("2d"),mes:document.getElementById("mes").getContext("2d"),width:480,height:480},q=17,k,D=["\u30a2\u30af\u30b5\u30ef\u30fc \u30dc\u30dc\u30cc\u30b6\u30a6\u30eb\u30b9 \u30d6\u30d9\u30c4 \u30d6\u30ed\u30ed\u30a6 \u30d3\u30e7\u30ed\u30dc\u30ed \u30c2\u30f4\u30a1\u30b6\u30f3 \u30c9\u30c9\u30ed\u30ce\u30b4\u30e1\u30b9 \u30c9\u30d5 \u30d5\u30a9\u30c3\u30c9 \u3054\u3093\u3056\u308c\u3059 \u30cf\u30f3\u30b7\u30fc \u30d8\u30a3\u30ed\u30fc\u30bb \u30d2\u30cd\u30ea \u30a4\u30d1\u30b5\u30b9\u30b3 \u30b8\u30e3\u30cd\u30f3 \u30b3\u30e0\u30b7 \u30b3\u30ed\u30be\u30a6 \u30de\u30af\u30b8\u30e7\u30a6 \u30de\u30e0\u30fc \u307e\u3055\u308b \u30f3\u30d0\u30b8\u30e7\u30fc \u30e9\u30b9\u30c8\u30c0\u30f3\u30b1 \u30b5\u30a4\u30b3 \u30b9\u30b5\u30a4\u30df \u30c6\u30ab\u30a4\u30f3 \u30c1\u30e5\u30d1\u30f3\u30c7\u30a3 \u30a6\u30e9\u30df".split(" "),"\u30a2\u30af\u30b5\u30ef\u30fc \u30dc\u30dc\u30cc\u30b6\u30a6\u30eb\u30b9 \u30d6\u30d9\u30c4 \u30d6\u30ed\u30ed\u30a6 \u30d3\u30e7\u30ed\u30dc\u30ed \u30c2\u30f4\u30a1\u30b6\u30f3 \u30c9\u30c9\u30ed\u30ce\u30b4\u30e1\u30b9 \u30c9\u30d5 \u30d5\u30a9\u30c3\u30c9 \u3054\u3093\u3056\u308c\u3059 \u30cf\u30f3\u30b7\u30fc \u30d8\u30a3\u30ed\u30fc\u30bb \u30d2\u30cd\u30ea \u30a4\u30d1\u30b5\u30b9\u30b3 \u30b8\u30e3\u30cd\u30f3 \u30b3\u30e0\u30b7 \u30b3\u30ed\u30be\u30a6 \u30de\u30af\u30b8\u30e7\u30a6 \u30de\u30e0\u30fc \u307e\u3055\u308b \u30f3\u30d0\u30b8\u30e7\u30fc \u30e9\u30b9\u30c8\u30c0\u30f3\u30b1 \u30b5\u30a4\u30b3 \u30b9\u30b5\u30a4\u30df \u30c6\u30ab\u30a4\u30f3 \u30c1\u30e5\u30d1\u30f3\u30c7\u30a3 \u30a6\u30e9\u30df".split(" ")],v=!1,z=function(a){!Model.get("mapAttr").get(Model.get("mapData").get(Model.get("chara").get("y"))[Model.get("chara").get("x")]).isEncountable||"test"!=a&&0!=(30*Math.random()|0)||(p("battle"),n({start:!0,monster:D[Model.get("mapData").get(Model.get("chara").get("y"))[Model.get("chara").get("x")]]}))},n=function(a){a.start&&(Model.get("cursor").set({maxX:1,maxY:1,x:0,y:0}),enemy=new Pokemon({name:a.monster[Math.random()*a.monster.length|0],lv:5}),enemy.set("img",new Image),enemy.get("img").src=enemy.get("src"),n({turnStart:!0}));a.turnStart&&(view.mes({message:enemy.get("name")+" \u304c\u73fe\u308c\u305f!\u3069\u3046\u3059\u308b?",dontWait:!0}),view.mes({message:"\u6226\u3046",x:-120,overwrite:!0,dontWait:!0}),view.mes({message:"\u30a2\u30a4\u30c6\u30e0",x:-60,overwrite:!0,dontWait:!0}),view.mes({message:"\u30dd\u30b1\u30e2\u30f3",x:-120,y:20,overwrite:!0,dontWait:!0}),view.mes({message:"\u9003\u3052\u308b",x:-60,y:20,overwrite:!0,dontWait:!0}),view.mes({message:">",x:-140+60*Model.get("cursor").get("x"),y:20*Model.get("cursor").get("y"),overwrite:!0,move:!0,dontWait:!0}));if(a.decide)switch(Model.get("cursor").num()){case 0:enemy.get("speed")<=friend.at(0).get("speed")?n({attack:[enemy,friend.at(0),friend.at(0).get("technique")[Model.get("cursor").get("x")+2*Model.get("cursor").get("y")]],next:function(){n({attack:[friend.at(0),enemy,enemy.get("technique")[4*Math.random()|0]]})}}):n({attack:[friend.at(0),enemy,enemy.get("technique")[4*Math.random()|0]],next:function(){"battle"==h&&n({attack:[enemy,friend.at(0),friend.at(0).get("technique")[Model.get("cursor").get("x")+2*Model.get("cursor").get("y")]]})}});break;case 1:view.mes({message:"\u30a2\u30a4\u30c6\u30e0!"});break;case 2:view.mes({message:"\u4ea4\u4ee3!"});break;case 3:view.mes({message:"\u3086\u304b\u308a\u306f\u9003\u3052\u3060\u3057\u305f!"}),Math.random()*(enemy.get("speed")-friend.at(0).get("speed"))|0?setTimeout(function(){view.mes({message:"\u3057\u304b\u3057\u9003\u3052\u304d\u308c\u306a\u304b\u3063\u305f!",callback:function(){n({attack:[friend.at(0),enemy]})}})},2):setTimeout(function(){view.mes({message:"\u9003\u3052\u304d\u308c\u305f!",callback:function(){p("map");h="map"}})},2)}if(a.attack){var b=a.attack[0].get("hp"),c=new Technique(a.attack[2]),c=Math.floor((2*a.attack[1].get("lv")/5+2)*c.get("damage")*a.attack[1].attack()/a.attack[0].defence()/50+2)*(16*Math.random()|85)/100;a.attack[1].get("item")&&a.attack[1].get("item").effect&&(-1!=Model.get("Func").searchArray(a.attack[1].get("item").effect.split(","),"attack")?c=Math.floor(c*Model.get("Func").parseInt(a.attack[1].get("item").effect.split(",")[Model.get("Func").searchArray(a.attack[1].get("item").effect.split(","),"attack")].split(" ")[1])):-1!=Model.get("Func").searchArray(a.attack[1].get("item").effect.split(","),"all")&&(c=Math.floor(c*a.attack[1].get("attack")*Model.get("Func").parseInt(a.attack[1].get("item").effect.split(",")[Model.get("Func").searchArray(a.attack[1].get("item").effect.split(","),"all")].split(" ")[1]))));0>c&&(c=0);c=Math.floor(c);a.attack[0].set("hp",a.attack[0].get("hp")-c);view.mes({message:a.attack[1].get("name")+" \u306e\u653b\u6483!"});console.log(a.attack[1].get("name")+" \u306e\u653b\u6483!");0>=a.attack[0].get("hp")?(setTimeout(function(){view.mes({message:a.attack[0].get("name")+" \u306b"+(b-a.attack[0].get("hp"))+" \u306e\u30c0\u30e1\u30fc\u30b8!"})},1),setTimeout(function(){view.mes({message:a.attack[0].get("name")+"\u3092\u5012\u3057\u305f!",callback:function(){n({end:!0})}})},2)):setTimeout(function(){view.mes({message:a.attack[0].get("name")+" \u306b"+(b-a.attack[0].get("hp"))+" \u306e\u30c0\u30e1\u30fc\u30b8!",callback:function(){a.next?a.next():n({turnStart:!0})}})},1)}a.end&&(p("map"),h="map")},E=function(){var a=0,b=0;switch(Model.get("chara").get("direction")){case "left":a=-1;break;case "front":b=1;break;case "right":a=1;break;case "back":b=-1}var c=0;-1!=(c=Model.get("Func").villagerDoesExist(Model.get("chara").get("x")+a,Model.get("chara").get("y")+b))?villagers.at(c).talk():view.mes({message:"\u305f\u304b\u3089\u3070\u3053\u3092\u3071\u3063\u3051\u3093\u3057\u305f\u3002"})},y=0,u=!1,e={width:200,height:250,nest:0},w=[{name:"\u30e1\u30cb\u30e5"},{name:"\u30ec\u30dd\u30fc\u30c8\u306b\u66f8\u304f"},{name:"\u8a2d\u5b9a"},{name:"\u624b\u6301\u3061\u306e\u30dd\u30b1\u30e2\u30f3"},{name:"\u30a2\u30a4\u30c6\u30e0"},{name:"\u30b2\u30fc\u30e0\u306b\u623b\u308b"},{name:"\u30bf\u30a4\u30c8\u30eb\u753b\u9762\u306b\u623b\u308b"}],s=[{name:"\u623b\u308b"}];if(x){b.height=320;for(var m in b)document.getElementById(m)&&(document.getElementById(m).height=b.height);document.getElementById("screen").style.height=b.height+"px";q=12}k=32*(q-2);var t={"chara1/left":new Image,"chara1/front":new Image,"chara1/right":new Image,"chara1/back":new Image,"chara1/left_left":new Image,"chara1/left_front":new Image,"chara1/left_right":new Image,"chara1/left_back":new Image,"chara1/right_left":new Image,"chara1/right_front":new Image,"chara1/right_right":new Image,"chara1/right_back":new Image,sand:new Image,grass:new Image,black:new Image,villager:new Image,farmer:new Image,blacksmith:new Image,butcher:new Image};b.map.drawImage(t.sand,0,0);for(m in t)t[m].src=m+".png";t.map=new Image;t.map.src="map/map.png";m=Backbone.View.extend({mes:function(){var a=[],d=[];return function(c){y++;v=!0;d.push(c);var e=setInterval(function(){if(!u||d[d.length-1].dontWait){c=d.shift();u=!0;y--;var l=c.message,f=c.x||20;0>f&&(f=480+f);var h=c.y?c.y+k-80+20:k-80+20;0>h&&(f=k+h);(overwrite=void 0===c.overwrite?!1:c.overwrite)||(a=[]);if(c.move){for(var g=a.length-1,m=!1;-1<g;g--)if(a[g].message==l){a[g].x=f;a[g].y=h;m=!0;break}!1==m&&a.push({message:l,x:f,y:h})}else a.push({message:l,x:f,y:h});b.mes.clearRect(0,k-80,480,k);b.mes.fillStyle="rgba(0,0,0,0.8)";b.mes.strokeStyle="#fff";b.mes.rect(0,k-80,480,80);b.mes.stroke();b.mes.strokeStyle="#000";b.mes.rect(2,k-80+2,476,76);b.mes.fill();b.mes.stroke();b.mes.shadowOffsetX=1;b.mes.shadowOffsetY=1;b.mes.shadowColor="rgba(0,0,0,0.3)";b.mes.fillStyle="#fff";g=0;for(l=a.length;g<l;g++)if(-1!=a[g].message.indexOf("\n"))for(g=0,l=a[g].message.split("\n").length;g<l;g++)b.mes.fillText(a[g].message.split("\n")[g],a[g].x,a[g].y+20*g);else b.mes.fillText(a[g].message,a[g].x,a[g].y);if(c.dontWait)v=u=!1,c.callback&&c.callback();else{var n=function(a){a.preventDefault&&a.preventDefault();if(32==a.keyCode){u=!1;window.removeEventListener("keydown",n,!1);for(a=0;a<r.length;a++)document.getElementById("pad_"+r[a][0]).removeEventListener("touchstart",q[a],!1);c.callback&&c.callback();0==y&&(v=!1,view.hide("mes"),p("map"))}},q=[];window.addEventListener("keydown",n,!1);for(g=0;g<r.length;g++)q.push(function(a){return function(b){b.preventDefault();n({keyCode:r[a][1]})}}(g)),document.getElementById("pad_"+r[g][0]).addEventListener("touchstart",q[g],!1)}clearInterval(e)}},20)}}(),mapImageAdd:function(a,d,c){b.chara.drawImage(t[a],32*d,32*c)},display:function(a){switch(a){case "title":view.show("title");break;case "setting":0==e.nest?Model.get("cursor").set({maxX:0,maxY:s.length-1}):Model.get("cursor").set({maxX:0,maxY:s[e.target].option.length-1});b.setting.clearRect(0,0,b.width,b.height);b.setting.rect((480-e.width)/2,(k-e.height)/2,e.width,e.height);b.setting.fillStyle=0==e.nest?"rgba(255,255,255,0.7)":"rgba(136,136,136,0.7)";b.setting.fill();b.setting.stroke();b.setting.fillStyle="#000";0==e.nest&&b.setting.fillText(">",Model.get("cursor").get("x")+(480-e.width)/2+2,20*Model.get("cursor").get("y")+(k-e.height)/2+20);a=b.setting.measureText("> ").width;for(var d=0,c=s.length;d<c;d++)b.setting.fillText(s[d].name,(480-e.width)/2+a,20*d+(k-e.height)/2+20);if(0<e.nest)for(b.setting.rect((480-e.width+40)/2+20,(k-e.height)/2,e.width-40,e.height),b.setting.fillStyle="rgba(255,255,255,0.7)",b.setting.fill(),b.setting.stroke(),b.setting.fillStyle="#000",b.setting.fillText(">",Model.get("cursor").get("x")+(480-e.width+40)/2+22,20*Model.get("cursor").get("y")+(k-e.height)/2+20),a=b.setting.measureText("> ").width,d=0,c=s[e.target].option.length;d<c;d++)b.setting.fillText(s[e.target].option[d],(480-e.width+40)/2+a+20,20*d+(k-e.height)/2+20);case "chara":view.hide("title");d=0;for(c=villagers.length;d<c;d++)if(villagers.at(d).get("isPainted")||(view.paint("villager",villagers.at(d).get("x"),villagers.at(d).get("y")),villagers.at(d).set("isPainted",!0)),villagers.at(d).get("move")&&0==(10*Math.random()|0)){switch(4*Math.random()|0){case 0:move(-1,0,!0,"villager["+d+"]");break;case 1:move(1,0,!0,"villager["+d+"]");break;case 2:move(0,1,!0,"villager["+d+"]");break;case 3:move(0,-1,!0,"villager["+d+"]")}view.paint("villager",villagers.at(d).get("x"),villagers.at(d).get("y"))}0!=Model.get("chara").get("doesWalk")&&(0!=Model.get("chara").get("doesRun")?Model.get("chara").incrementWalk(2):Model.get("chara").incrementWalk());if(0<Model.get("chara").get("doesRun"))switch(Model.get("chara").incrementRun(),Model.get("chara").get("doesRun")%4){case 0:case 1:view.mapImageAdd("chara1/left_"+Model.get("chara").get("direction"),8,q/2|0);break;case 2:case 3:view.mapImageAdd("chara1/right_"+Model.get("chara").get("direction"),8,q/2|0)}else switch(Model.get("chara").get("doesWalk")){case 0:case 2:case 3:view.mapImageAdd("chara1/"+Model.get("chara").get("direction"),8,q/2|0);break;case 4:case 5:view.mapImageAdd("chara1/left_"+Model.get("chara").get("direction"),8,q/2|0);break;case 6:case 7:view.mapImageAdd("chara1/right_"+Model.get("chara").get("direction"),8,q/2|0)}f.left=32*-(Model.get("chara").get("x")-8)+"px";f.top=32*-(Model.get("chara").get("y")-(q/2|0))+"px";if(0==Model.get("chara").get("doesRun"))switch(Model.get("chara").get("direction")){case "left":f.left=parseInt(f.left,10)+4*Model.get("chara").get("doesWalk")+"px";break;case "front":f.top=parseInt(f.top,10)-4*Model.get("chara").get("doesWalk")+"px";break;case "right":f.left=parseInt(f.left,10)-4*Model.get("chara").get("doesWalk")+"px";break;case "back":f.top=parseInt(f.top,10)+4*Model.get("chara").get("doesWalk")+"px"}else switch(Model.get("chara").get("direction")){case "left":f.left=parseInt(f.left,10)+8*(Model.get("chara").get("doesRun")%4)+"px";break;case "front":f.top=parseInt(f.top,10)-8*(Model.get("chara").get("doesRun")%4)+"px";break;case "right":f.left=parseInt(f.left,10)-8*(Model.get("chara").get("doesRun")%4)+"px";break;case "back":f.top=parseInt(f.top,10)+8*(Model.get("chara").get("doesRun")%4)+"px"}if(7<=Model.get("chara").get("doesWalk")||4<=Model.get("chara").get("doesWalk")&&0!=Model.get("chara").get("doesRun"))switch(Model.get("chara").resetWalk(),Model.get("isKeyPressed").get("d")&&(Model.get("isKeyPressed").get("left")&&move(-1,0,!1)||Model.get("isKeyPressed").get("up")&&move(0,1,!1)||Model.get("isKeyPressed").get("right")&&move(1,0,!1)||Model.get("isKeyPressed").get("down")&&move(0,-1,!1))?Model.get("chara").incrementRun():Model.get("chara").resetRun(),Model.get("chara").get("direction")){case "left":move(-1,0,!0);break;case "front":move(0,1,!0);break;case "right":move(1,0,!0);break;case "back":move(0,-1,!0)}break;case "battle":view.hide("title").show("enemy");b.battle.fillStyle="#fff";b.battle.fillRect(0,0,480,k);break;case "talk":view.hide("title");break;case "menu":for(view.hide("title"),Model.get("cursor").set("maxX",0),Model.get("cursor").set("maxY",w.length-2),b.menu.clearRect(0,0,b.width,b.height),b.menu.rect(180,(k-140)/2,120,140),b.menu.fillStyle="rgba(255,255,255,0.7)",b.menu.fill(),b.menu.stroke(),b.menu.fillStyle="#000",b.menu.fillText(">",Model.get("cursor").get("x")+180+2,20*Model.get("cursor").get("y")+(k-140)/2+40),a=b.menu.measureText("> ").width,d=0,c=w.length;d<c;d++)b.menu.fillText(w[d].name,180+a,20*d+(k-140)/2+20)}},show:function(a){switch(a){case "title":b.chara.fillStyle="#fff";b.chara.fillRect(0,0,b.width,b.height);b.chara.font="18px 'MS P\u30b4\u30b7\u30c3\u30af'";b.chara.fillStyle="#000";b.chara.fillText("\u30dd\u30b1\u2606\u30e2\u30f3",(b.width-b.chara.measureText("\u30dd\u30b1\u2606\u30e2\u30f3").width)/2,200);break;case "battle":b.battle.clearRect(0,0,480,k);break;case "enemy":x?b.enemy.drawImage(enemy.get("img"),140,0,200,200):b.enemy.drawImage(enemy.get("img"),80,0,320,320)}return view},hide:function(a){switch(a){case "menu":b.menu.clearRect(0,0,b.width,b.height);Model.get("cursor").set("y",0);break;case "mes":case "battle":case "enemy":case "setting":b[a].clearRect(0,0,480,k)}return view},paint:function(a,d,c,e,f,h,k){void 0===e&&(h=d,d=0,e=32,k=c,c=0,f=32);b.map.drawImage(t[a],d,c,e,f,32*h,32*k,32,32)},textWidth:function(a){return b.menu.measureText(a).width},clear:function(a){b[a].clearRect(0,0,b.width,b.height)},write:function(a,d,c,e){b[a].fillText(d,c||0,e||0)},keyAction:function(a){if(!v)switch(a){case "left":case "right":case "up":case "down":switch(h){case "map":Model.get("isKeyPressed").get("d")?1>=Model.get("chara").get("doesWalk")&&("up"!=a&&"down"!=a?Model.get("chara").run(a):"up"==a?Model.get("chara").run("back"):"down"==a&&Model.get("chara").run("front")):0==Model.get("chara").get("doesWalk")&&("up"!=a&&"down"!=a?Model.get("chara").walk(a):"up"==a?Model.get("chara").walk("back"):"down"==a&&Model.get("chara").walk("front"));break;case "menu":case "setting":1===Model.get("isKeyPressed").get(a)&&Model.get("cursor").move(a);break;case "battle":1===Model.get("isKeyPressed").get(a)&&(Model.get("cursor").move(a,!1),view.mes({message:">",x:-140+60*Model.get("cursor").get("x"),y:20*Model.get("cursor").get("y"),overwrite:!0,move:!0,dontWait:!0}))}break;case "m":"menu"==h?p("map"):p("menu");break;case "e":testMode&&"battle"!=h&&z("test");break;case "space":switch(h){case "map":0==Model.get("chara").get("doesWalk")&&(p("talk"),E(),setTimeout(function(){u=!0},21));break;case "menu":switch(w[Model.get("cursor").get("y")+1].name){case "\u30ec\u30dd\u30fc\u30c8\u306b\u66f8\u304f":C("save_data",JSON.stringify(_.map(Model.models,function(a){if("mapData"!=a.id)return a.toJSON()})),60);view.mes({message:"\u30ec\u30dd\u30fc\u30c8\u3092\u66f8\u304d\u307e\u3057\u305f\u3002"});break;case "\u8a2d\u5b9a":p("setting");break;case "\u30b2\u30fc\u30e0\u306b\u623b\u308b":p("map");break;case "\u30bf\u30a4\u30c8\u30eb\u753b\u9762\u306b\u623b\u308b":p("title")}break;case "setting":if(0==e.nest)switch(s[Model.get("cursor").get("y")].name){case "\u623b\u308b":p("menu")}else if(1==e.nest)switch(s[e.target].name){case "\u623b\u308b":p("menu")}break;case "title":p("map");break;case "battle":console.log("keyAction"),n({decide:!0})}break;case "leave left":case "leave right":case "leave up":case "leave down":Model.get("chara").resetRun()}},routine:function(){view.clear("chara");for(var a in Model.get("isKeyPressed").attributes)0<Model.get("isKeyPressed").attributes[a]&&(view.keyAction(a),Model.get("isKeyPressed").increment(a));switch(h){case "title":view.display("title");break;case "map":view.display("map");view.display("chara");break;case "battle":view.display("battle");break;case "talk":view.display("map");view.display("chara");view.display("talk");break;case "menu":view.display("map");view.display("chara");view.display("menu");break;case "setting":view.display("map"),view.display("chara"),view.display("setting")}}});var p=function(){var a=h;return function(b){switch(a){case "menu":view.hide("screen").hide("charaScreen").hide("menu");break;case "talk":view.hide("screen").hide("charaScreen").hide("mes");break;case "map":view.hide("screen").hide("charaScreen");break;case "title":view.hide("title");break;case "battle":view.hide("mes").hide("battle").hide("enemy");break;case "setting":view.hide("setting")}switch(b){case "menu":h="menu";view.show("screen").show("charaScreen").show("menu");break;case "talk":h="talk";view.show("screen").show("charaScreen").show("mes");break;case "map":h="map";view.show("screen").show("charaScreen");break;case "title":h="title";view.show("title");break;case "battle":h="battle";view.show("mes").show("battle");break;case "setting":h="setting",view.show("screen").show("charaScreen").show("setting")}a=b}}();view=new m;document.getElementById("map").width=32*Model.get("world").get("width");document.getElementById("map").height=32*Model.get("world").get("height");setTimeout(function(){for(var a=0;a<Model.get("world").get("height");a++)for(var b=0;b<Model.get("world").get("width");b++)void 0!==Model.get("mapData").get(a)&&void 0!==Model.get("mapData").get(a)[b]?view.paint("map",Model.get("mapAttr").get(Model.get("mapData").get(a)[b]).img[0],Model.get("mapAttr").get(Model.get("mapData").get(a)[b]).img[1],16,16,b,a):view.paint(Model.get("mapAttr").get("-1").img,32*b,32*a);document.getElementById("screen").style.background="#000"},100);move=function(a,b,c,e){return Model.get("chara").get("x")+a<=Model.get("world").get("width")-1&&0<=Model.get("chara").get("x")+a&&Model.get("chara").get("y")+b<=Model.get("world").get("height")-1&&0<=Model.get("chara").get("y")+b&&Model.get("mapAttr").get(Model.get("mapData").get(Model.get("chara").get("y")+b)[Model.get("chara").get("x")+a]).isNotBarrier&&-1==Model.get("Func").villagerDoesExist(Model.get("chara").get("x")+a,Model.get("chara").get("y")+b)?(c&&(Model.get("chara").incrementX(a),Model.get("chara").incrementY(b)),doesEncount&&z(),!0):!1};var A=function(a){32==a.keyCode&&(a.preventDefault&&a.preventDefault(),Model.get("isKeyPressed").set("space",0));37==a.keyCode&&(a.preventDefault&&a.preventDefault(),Model.get("isKeyPressed").set("left",0),view.keyAction("leave left"));38==a.keyCode&&(a.preventDefault&&a.preventDefault(),Model.get("isKeyPressed").set("up",0),view.keyAction("leave up"));39==a.keyCode&&(a.preventDefault&&a.preventDefault(),Model.get("isKeyPressed").set("right",0),view.keyAction("leave right"));40==a.keyCode&&(a.preventDefault&&a.preventDefault(),Model.get("isKeyPressed").set("down",0),view.keyAction("leave down"));77==a.keyCode&&(a.preventDefault&&a.preventDefault(),Model.get("isKeyPressed").set("m",0));69==a.keyCode&&(a.preventDefault&&a.preventDefault(),Model.get("isKeyPressed").set("e",0));68==a.keyCode&&(a.preventDefault&&a.preventDefault(),Model.get("isKeyPressed").set("d",0))},B=function(a){32==a.keyCode&&(a.preventDefault&&a.preventDefault(),0==Model.get("isKeyPressed").get("space")&&(view.keyAction("space"),Model.get("isKeyPressed").get("space",-1)));37==a.keyCode&&(a.preventDefault&&a.preventDefault(),0===Model.get("isKeyPressed").get("left")&&Model.get("isKeyPressed").increment("left"));38==a.keyCode&&(a.preventDefault&&a.preventDefault(),0===Model.get("isKeyPressed").get("up")&&Model.get("isKeyPressed").increment("up"));39==a.keyCode&&(a.preventDefault&&a.preventDefault(),0===Model.get("isKeyPressed").get("right")&&Model.get("isKeyPressed").increment("right"));40==a.keyCode&&(a.preventDefault&&a.preventDefault(),0===Model.get("isKeyPressed").get("down")&&Model.get("isKeyPressed").increment("down"));68==a.keyCode&&(a.preventDefault&&a.preventDefault(),0===Model.get("isKeyPressed").get("d")&&Model.get("isKeyPressed").increment("d"));77==a.keyCode&&(a.preventDefault&&a.preventDefault(),0!=Model.get("isKeyPressed").get("m")||Model.get("isKeyPressed").get("m")||(view.keyAction("m"),Model.get("isKeyPressed").set("m",-1)));69==a.keyCode&&testMode&&(a.preventDefault&&a.preventDefault(),0==Model.get("isKeyPressed").get("e")&&(view.keyAction("e"),Model.get("isKeyPressed").set("e",-1)))};window.addEventListener("keyup",A,!1);window.addEventListener("keydown",B,!1);var r=[["space",32],["left",37],["up",38],["right",39],["down",40],["D",68],["M",77]];if(x)for(document.getElementById("pad").style.display="block",m=0;m<r.length;m++)document.getElementById("pad_"+r[m][0]).addEventListener("touchstart",function(a){return function(b){b.preventDefault();B({keyCode:r[a][1]})}}(m),!1),document.getElementById("pad_"+r[m][0]).addEventListener("touchend",function(a){return function(b){b.preventDefault();A({keyCode:r[a][1]})}}(m),!1);setInterval(view.routine,IntervalTime)},!1);