var testMode=!1,doesEncount=!0,logMode=!1,IntervalTime=50;window.addEventListener("load",function(){function N(a,c,h){var q=location.pathname,f=[],f=q.split("/");""!=f[f.length-1]&&(f[f.length-1]="",q=f.join("/"));f=(new Date).getTime();f=(new Date(f+864E5*h)).toUTCString();a=""+(a+"="+escape(c));a+="; path="+q;document.cookie=h?a+("; expires="+f+"; "):a+"; "}function I(){if(0==Model.get("chara").get("doesRun"))switch(Model.get("chara").get("direction")){case "left":x.left=y.left=w.left=A.left+a.chipSize/7*Model.get("chara").get("doesWalk")+"px";break;case "front":x.top=y.top=w.top=A.top-a.chipSize/7*Model.get("chara").get("doesWalk")+"px";break;case "right":x.left=y.left=w.left=A.left-a.chipSize/7*Model.get("chara").get("doesWalk")+"px";break;case "back":x.top=y.top=w.top=A.top+a.chipSize/7*Model.get("chara").get("doesWalk")+"px"}else switch(Model.get("chara").get("direction")){case "left":x.left=y.left=w.left=A.top+a.chipSize/4*(Model.get("chara").get("doesRun")%4)+"px";break;case "front":x.top=y.top=w.top=A.top-a.chipSize/4*(Model.get("chara").get("doesRun")%4)+"px";break;case "right":x.left=y.left=w.left=A.top-a.chipSize/4*(Model.get("chara").get("doesRun")%4)+"px";break;case "back":x.top=y.top=w.top=A.top+a.chipSize/4*(Model.get("chara").get("doesRun")%4)+"px"}}function J(){c.map.clearRect(0,0,document.getElementById("map").width,document.getElementById("map").height);c.frontMap.clearRect(0,0,document.getElementById("frontMap").width,document.getElementById("map").height);for(var d=a.height/2|0,g=a.width/2|0,h=Model.get("chara").get("y"),q=Model.get("chara").get("x"),d=d+1,g=g+1,f=0;f<a.height;f++)for(var b=0;b<a.width;b++){if(void 0!==Model.get("mapData").get(f-d+h)&&void 0!==Model.get("mapData").get(f-d+h)[b-g+q]){var G=Model.get("mapData").get(f-d+h)[b-g+q],l=Model.get("mapAttr").get(G).img;view.paint("map",l[2],l[0],l[1],a.chipSize,a.chipSize,b,f)}else view.paint("map",Model.get("mapAttr").get("-1").img,b*a.chipSize,f*a.chipSize);void 0!==Model.get("frontMapData").get(f-d+h)&&void 0!==Model.get("frontMapData").get(f-d+h)[b-g+q]&&(G=Model.get("frontMapData").get(f-d+h)[b-g+q],l=Model.get("mapAttr").get(G).img,0!=G&&view.paint("frontMap",l[2],l[0],l[1],a.chipSize,a.chipSize,b,f))}view.clear("villager",0,0,a.width*a.chipSize,a.height*a.chipSize);d=0;for(g=villagers.length;d<g;d++){if(villagers.at(d).get("move")&&0==(100*Math.random()|0)&&"talk"!=k&&"menu"!=k)switch(4*Math.random()|0){case 0:villagers.at(d).get("x")-1>=villagers.at(d).get("defaultX")-villagers.at(d).get("range")&&(move(-1,0,!0,villagers.at(d)),villagers.at(d).set("direction","left"));break;case 1:villagers.at(d).get("x")+1<=villagers.at(d).get("defaultX")+villagers.at(d).get("range")&&(move(1,0,!0,villagers.at(d)),villagers.at(d).set("direction","right"));break;case 2:villagers.at(d).get("y")+1<=villagers.at(d).get("defaultY")+villagers.at(d).get("range")&&(move(0,1,!0,villagers.at(d)),villagers.at(d).set("direction","front"));break;case 3:villagers.at(d).get("y")-1>=villagers.at(d).get("defaultY")-villagers.at(d).get("range")&&(move(0,-1,!0,villagers.at(d)),villagers.at(d).set("direction","back"))}view.drawVillager(d)}}function O(){for(var a in p)p[a].src=a+".png";p["map.png"]=new Image;p["map.png"].src="map/map.png";p["shops.gif"]=new Image;p["shops.gif"].src="map/shops.gif";var c=0;for(a in p)p[a].onload=S,c++;p.Length=c}function T(d){App.log("main called");view=new (Backbone.View.extend({mes:function(){var b=[],d=[];return function(l){"string"==typeof l&&(l={message:l});l.doesSwitchMode=void 0!==l.doesSwitchMode?l.doesSwitchMode:!0;H++;F=!0;d.push(l);var h=setInterval(function(){if(!C||d[d.length-1].dontWait){l=d.shift();C=!0;H--;var f=l.message,g=l.x||20;0>g&&(g=a.realWidth+g);var e=l.y?l.y+a.realHeight-v.height+20:a.realHeight-v.height+20;0>e&&(g=a.realHeight+e);(overwrite=void 0===l.overwrite?!1:l.overwrite)||(b=[]);if(l.move){for(var n=b.length-1,k=!1;-1<n;n--)if(b[n].message==f){b[n].x=g;b[n].y=e;k=!0;break}!1==k&&b.push({message:f,x:g,y:e})}else b.push({message:f,x:g,y:e});c.mes.clearRect(0,a.realHeight-v.height,a.realWidth,a.realHeight);view.strokeMesBox();c.mes.shadowOffsetX=c.mes.shadowOffsetY=1;c.mes.shadowColor="rgba(0,0,0,0.3)";c.mes.fillStyle="#fff";n=0;for(f=b.length;n<f;n++)if(-1!=b[n].message.indexOf("\n"))for(n=0,f=b[n].message.split("\n").length;n<f;n++)c.mes.fillText(b[n].message.split("\n")[n],b[n].x,b[n].y+20*n);else c.mes.fillText(b[n].message,b[n].x,b[n].y);if(l.dontWait)F=C=!1,l.callback&&l.callback();else{var m=function(b){32==b.keyCode&&(C=!1,window.removeEventListener("keydown",m,!1),window.removeEventListener("touchstart",p,!1),p=void 0,l.callback&&l.callback(),0==H&&(F=!1,view.hide("mes"),l.doesSwitchMode&&r("map")))},p=function(b){m({keyCode:q[b.target.id]})};window.addEventListener("keydown",m,!1);window.addEventListener("touchstart",p,!1)}clearInterval(h)}},20)}}(),strokeMesBox:function(){c.mes.fillStyle="rgba(0,0,0,0.7)";c.mes.strokeStyle="#fff";c.mes.rect(0,a.realHeight-v.height,a.realWidth,v.height);c.mes.stroke();c.mes.strokeStyle="#000";c.mes.rect(2,a.realHeight-v.height+2,a.realWidth-4,v.height-4);c.mes.fill();c.mes.stroke()},select:function(b){c[b.canvas].fillStyle=b.color;b.hideCursor||c[b.canvas].fillText(">",Model.get("cursor").get("x")+b.x+2,20*Model.get("cursor").get("y")+b.y);for(var a=c[b.canvas].measureText("> ").width,d=0;d<b.options.length;d++)c[b.canvas].fillText(b.options[d],b.x+a,b.y+20*d);var f=function(a){a.preventDefault&&a.preventDefault();32==a.keyCode&&(C=!1,window.removeEventListener("keydown",f,!1),window.removeEventListener("touchstart",g,!1),f=void 0,b.callback&&b.callback(Model.get("cursor").num()),0==H&&(F=!1,view.hide("mes"),b.doesSwitchMode&&r("map")))},g=function(b){f({keyCode:q[b.target.id]})};window.addEventListener("keydown",f,!1);window.addEventListener("touchstart",g,!1)},charaDraw:function(){var b="",d="";return function(f){var g=Model.get("chara").get("direction");g==b&&f==d&&f||(b=g,d=f,c.chara.clearRect((a.width/2|0)*a.chipSize,(a.height/2|0)*a.chipSize,a.chipSize,a.chipSize),"front"==g?g=0:"left"==g?g=1:"right"==g?g=2:"back"==g&&(g=3),"left"==f?c.chara.drawImage(p[Model.get("chara").get("img")],0,32*g,a.chipSize,a.chipSize,(a.width/2|0)*a.chipSize,(a.height/2|0)*a.chipSize,a.chipSize,a.chipSize):"right"==f?c.chara.drawImage(p[Model.get("chara").get("img")],2*a.chipSize,32*g,a.chipSize,a.chipSize,(a.width/2|0)*a.chipSize,(a.height/2|0)*a.chipSize,a.chipSize,a.chipSize):c.chara.drawImage(p[Model.get("chara").get("img")],a.chipSize,32*g,a.chipSize,a.chipSize,(a.width/2|0)*a.chipSize,(a.height/2|0)*a.chipSize,a.chipSize,a.chipSize))}}(),display:function(b){switch(b){case "title":view.show("title");break;case "setting":0==e.nest?Model.get("cursor").set({maxX:0,maxY:z.length-1}):Model.get("cursor").set({maxX:0,maxY:z[e.target].option.length-1}),c.menu.beginPath(),c.clear("menu"),c.menu.rect((a.realWidth-e.width)/2,(a.realHeight-e.height)/2,e.width,e.height),c.menu.fillStyle=0==e.nest?"rgba(255,255,255,0.7)":"rgba(136,136,136,0.7)",c.menu.fill(),c.menu.stroke(),view.select({canvas:"menu",options:d.map(z,function(b){return b.name}),x:(a.realWidth-e.width)/2+10,y:(a.realHeight-e.height)/2+20,color:"#000",hideCursor:0!=e.nest}),c.menu.closePath(),0<e.nest&&(c.menu.beginPath(),c.menu.rect((a.realWidth-e.width+40)/2+20,(a.realHeight-e.height)/2,e.width-40,e.height),c.menu.fillStyle="rgba(255,255,255,0.7)",c.menu.fill(),c.menu.stroke(),view.select({canvas:"menu",options:z[e.target].option,x:(a.realWidth-e.width+40)/2+20,y:(a.realHeight-e.height)/2+20,color:"#000"}),c.menu.closePath());case "chara":0!=Model.get("chara").get("doesWalk")&&(0!=Model.get("chara").get("doesRun")?Model.get("chara").incrementWalk(2):Model.get("chara").incrementWalk());if(0<Model.get("chara").get("doesRun"))switch(Model.get("chara").incrementRun(),Model.get("chara").get("doesRun")%4){case 0:case 1:view.charaDraw("left");break;case 2:case 3:view.charaDraw("right")}else switch(Model.get("chara").get("doesWalk")){case 0:case 2:case 3:view.charaDraw("front");break;case 4:case 5:view.charaDraw("left");break;case 6:case 7:view.charaDraw("right")}I();if(7<=Model.get("chara").get("doesWalk")||4<=Model.get("chara").get("doesWalk")&&0!=Model.get("chara").get("doesRun")){Model.get("chara").resetWalk();Model.get("isKeyPressed").get("d")&&(Model.get("isKeyPressed").get("left")&&move(-1,0,!1)||Model.get("isKeyPressed").get("up")&&move(0,1,!1)||Model.get("isKeyPressed").get("right")&&move(1,0,!1)||Model.get("isKeyPressed").get("down")&&move(0,-1,!1))?Model.get("chara").incrementRun():Model.get("chara").resetRun();switch(Model.get("chara").get("direction")){case "left":move(-1,0,!0);break;case "front":move(0,1,!0);break;case "right":move(1,0,!0);break;case "back":move(0,-1,!0)}I();J()}break;case "battle":K?c.battle.drawImage(enemy.get("img"),(a.realWidth-200)/2,0,200,200):c.battle.drawImage(enemy.get("img"),(a.realWidth-320)/2,0,320,320);break;case "menu":Model.get("cursor").set("maxX",0);Model.get("cursor").set("maxY",L.length-1);c.menu.beginPath();c.clear("menu");c.menu.rect((a.realWidth-D.width)/2,(a.realHeight-D.height)/2,D.width,D.height);c.menu.fillStyle="rgba(255,255,255,0.7)";c.menu.fill();c.menu.stroke();c.menu.fillStyle="#000";view.select({canvas:"menu",options:d.map(L,function(b){return b.name}),x:(a.realWidth-D.width)/2+10,y:(a.realHeight-D.height)/2+20});c.menu.closePath();break;case "friendPokemonView":Model.get("cursor").set("maxX",1);Model.get("cursor").set("maxY",2);c.menu.beginPath();c.menu.fillStyle="#9CF";c.menu.fillRect(0,0,a.realWidth,a.realHeight);c.menu.closePath();c.menu.fillStyle="#000";c.menu.beginPath();b=0;for(var g=friend.length;b<g;b++)c.menu.fillText(friend.at(b).get("nickname"),a.realWidth/2*(b%2)+6,a.realHeight/3*(b/2|0)+20),c.menu.fillText(friend.at(b).get("hp")+"/"+friend.at(b).get("maxHp"),a.realWidth/2*(b%2)+6,a.realHeight/3*(b/2|0)+40),c.menu.rect(a.realWidth/2*(b%2)+2,a.realHeight/3*(b/2|0)+2,a.realWidth/2-4,a.realHeight/3-4);c.menu.closePath();c.menu.stroke();break;case "changePokemonView":for(c.menu.beginPath(),c.menu.fillStyle="#9CF",c.menu.fillRect(0,0,a.realWidth,a.realHeight),c.menu.closePath(),c.menu.fillStyle="#000",b=0,g=friend.length;b<g;b++)c.menu.beginPath(),c.menu.fillText(friend.at(b).get("nickname"),a.realWidth/2*(b%2)+6,a.realHeight/3*(b/2|0)+20),c.menu.fillText(friend.at(b).get("hp")+"/"+friend.at(b).get("maxHp"),a.realWidth/2*(b%2)+6,a.realHeight/3*(b/2|0)+40),Model.get("cursor").num()==b?c.menu.strokeStyle="#f00":c.menu.strokeStyle="#000",c.menu.rect(a.realWidth/2*(b%2)+2,a.realHeight/3*(b/2|0)+2,a.realWidth/2-4,a.realHeight/3-4),c.menu.stroke(),c.menu.closePath()}},show:function(b){switch(b){case "map":w.display=y.display=x.display="block";break;case "title":c.chara.fillStyle="#fff";c.chara.fillRect(0,0,c.width,c.height);c.chara.font="18px 'MS P\u30b4\u30b7\u30c3\u30af'";c.chara.fillStyle="#000";c.chara.fillText("\u30dd\u30b1\u2606\u30e2\u30f3",(c.width-c.chara.measureText("\u30dd\u30b1\u2606\u30e2\u30f3").width)/2,200);c.chara.fillText("ver "+Model.get("info").get("version"),(c.width-c.chara.measureText("ver "+Model.get("info").get("version")).width)/2,230);break;case "battle":c.battle.fillStyle="#fff",c.battle.fillRect(0,0,a.realWidth,a.realHeight)}return view},hide:function(b){switch(b){case "map":w.display=y.display=x.display="none";break;case "charaScreen":c.clear("chara");break;case "menu":c.clear("menu");Model.get("cursor").set("y",0);break;case "title":c.clear("chara");break;case "mes":case "battle":case "enemy":c[b].clearRect(0,0,a.realWidth,a.realHeight)}return view},paint:function(b,d,g,f,h,e,q,k){void 0===h&&(q=g,g=0,h=a.chipSize,k=f,f=0,e=a.chipSize);c[b].drawImage(p[d],g,f,h,e,q*a.chipSize,k*a.chipSize,a.chipSize,a.chipSize)},drawVillager:function(b){var c=villagers.at(b).get("x")-Model.get("chara").get("x")+(a.width/2|0)+1,d=villagers.at(b).get("y")-Model.get("chara").get("y")+(a.height/2|0)+1;switch(villagers.at(b).get("direction")){case "front":view.paint("villager","villager/"+villagers.at(b).get("job"),32,0,32,32,c,d);break;case "left":view.paint("villager","villager/"+villagers.at(b).get("job"),32,32,32,32,c,d);break;case "right":view.paint("villager","villager/"+villagers.at(b).get("job"),32,64,32,32,c,d);break;case "back":view.paint("villager","villager/"+villagers.at(b).get("job"),32,96,32,32,c,d)}},clear:function(b,d,g,f,h){void 0===f&&(h=f=a.chipSize);c[b].clearRect(d*a.chipSize,g*a.chipSize,f,h)},textWidth:function(b){return c.menu.measureText(b).width},write:function(b,a,d,g){c[b].fillText(a,d||0,g||0)},keyAction:function(b){if(!F)switch(b){case "left":case "right":case "up":case "down":switch(k){case "map":Model.get("isKeyPressed").get("d")?1>=Model.get("chara").get("doesWalk")&&("up"!=b&&"down"!=b?Model.get("chara").run(b):"up"==b?Model.get("chara").run("back"):"down"==b&&Model.get("chara").run("front")):0==Model.get("chara").get("doesWalk")&&("up"!=b&&"down"!=b?Model.get("chara").walk(b):"up"==b?Model.get("chara").walk("back"):"down"==b&&Model.get("chara").walk("front"));break;case "menu":case "setting":case "changePokemonView":1===Model.get("isKeyPressed").get(b)&&Model.get("cursor").move(b);break;case "battle":1===Model.get("isKeyPressed").get(b)&&(Model.get("cursor").move(b,!1),view.mes({message:">",x:-140+60*Model.get("cursor").get("x"),y:20*Model.get("cursor").get("y"),overwrite:!0,move:!0,dontWait:!0}))}break;case "m":"menu"==k?(App.log("map close."),r("map")):"map"==k&&(App.log("map open."),r("menu"));break;case "e":testMode&&"battle"!=k&&P("test");break;case "space":switch(k){case "map":0==Model.get("chara").get("doesWalk")&&(r("talk"),U());break;case "menu":switch(L[Model.get("cursor").get("y")].name){case "\u56f3\u9451":Model.get("pokedex").view();view.mes({message:"\u672a\u5b9f\u88c5\u3060\u3088!\u3044\u307e\u3084\u3063\u3066\u308b\u3088!",doesSwitchMode:!1});break;case "\u30ec\u30dd\u30fc\u30c8\u306b\u66f8\u304f":N("save_data",JSON.stringify(d.map(Model.models,function(b){if("chara"==b.id||"setting"==b.id||"info"==b.id)return b.toJSON()})),60);view.mes("\u30ec\u30dd\u30fc\u30c8\u3092\u66f8\u304d\u307e\u3057\u305f\u3002");break;case "\u8a2d\u5b9a":r("setting");break;case "\u624b\u6301\u3061\u306e\u30dd\u30b1\u30e2\u30f3":k="friendPokemonView";break;case "\u30a2\u30a4\u30c6\u30e0":c.menu.beginPath();c.clear("menu");c.menu.rect((a.realWidth-e.width)/2,(a.realHeight-e.height)/2,e.width,e.height);c.menu.fillStyle=0==e.nest?"rgba(255,255,255,0.7)":"rgba(136,136,136,0.7)";c.menu.fill();c.menu.stroke();view.select({canvas:"menu",options:d.flatten([d.map(Model.get("chara").get("item"),function(b){return b.get("name")}),"\u623b\u308b"]),x:(a.realWidth-e.width)/2+10,y:(a.realHeight-e.height)/2+20,color:"#000"});c.menu.closePath();break;case "\u30b2\u30fc\u30e0\u306b\u623b\u308b":App.log("return to game");r("map");break;case "\u30bf\u30a4\u30c8\u30eb\u753b\u9762\u306b\u623b\u308b":App.log("return to title");r("title");break;case "\u30bb\u30fc\u30d6\u30c7\u30fc\u30bf\u3092\u6d88\u3059":view.mes({message:"\u672c\u5f53\u306b\u6d88\u3057\u307e\u3059\u304b?",callback:function(){view.strokeMesBox();view.select({canvas:"mes",options:["\u306f\u3044","\u3044\u3044\u3048"],x:0,y:440,callback:function(b){0==b?(N("save_data","",60),view.mes("\u30bb\u30fc\u30d6\u30c7\u30fc\u30bf\u3092\u6d88\u3057\u307e\u3057\u305f\u3002")):1==b&&view.mes("\u30ad\u30e3\u30f3\u30bb\u30eb\u3057\u307e\u3057\u305f\u3002")}})},doesSwitchMode:!1});break;case "App":document.write("<pre>"+App.show()+'</pre>\u3053\u308c\u3092<a href="mailto:sc1enth@gmail.com?subject=Log&amp;body='+App.show().replace(/\n/g,"%0d%0a")+'">sc1enth@gmail.com</a>\u3078\u9001\u4fe1\u3057\u3066\u304f\u3060\u3055\u3044\u3002\u4e0b\u306e\u30e1\u30fc\u30eb\u30d5\u30a9\u30fc\u30e0\u304b\u3089\u3082\u53ef\u80fd\u3067\u3059\u3002\u305d\u306e\u5834\u5408\u306f\u304a\u554f\u3044\u5408\u308f\u305b\u5185\u5bb9\u306f\u4e0a\u306e\u30ed\u30b0(\u5909\u306a\u6570\u5b57\u3084\u82f1\u8a9e\u306e\u66f8\u3044\u3066\u3042\u308b\u6587\u5b57\u5217)\u3092\u8cbc\u308a\u4ed8\u3051\u3066\u3001\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u306f\u66f8\u304d\u305f\u304f\u306a\u3044\u65b9\u306f sc1enth@gmail.com \u306b\u3057\u3066\u9001\u4fe1\u304f\u3060\u3055\u3044(\u8fd4\u4fe1\u304c\u5fc5\u8981\u306a\u5834\u5408\u306a\u3069\u306f\u79c1\u304c\u9001\u4fe1\u3067\u304d\u308b\u30e1\u30fc\u30eb\u30a2\u30c9\u30ec\u30b9\u3092\u5165\u529b\u304f\u3060\u3055\u3044)\u3002<script src="http://form1.fc2.com/parts/index.php?id=725872">\x3c/script><noscript><a href="http://form1.fc2.com/form/?id=725872" target="_blank">[FC2\u30e1\u30fc\u30eb\u30d5\u30a9\u30fc\u30e0]</a></noscript>')}break;case "setting":if(0==e.nest)switch(z[Model.get("cursor").get("y")].name){case "\u97f3\u91cf":case "\u30ad\u30e3\u30e9\u753b\u50cf":e.nest=1;e.target=Model.get("cursor").get("y");Model.get("cursor").set("y",0);break;case "\u623b\u308b":r("menu")}else if(1==e.nest)switch(z[e.target].name){case "\u97f3\u91cf":switch(z[e.target].option[Model.get("cursor").get("y")]){case "0%":case "50%":case "100%":Model.get("setting").set("volume",Model.get("Func").parseInt(z[e.target].option[Model.get("cursor").get("y")]));break;case "\u623b\u308b":e.nest=0,Model.get("cursor").set("y",0)}break;case "\u30ad\u30e3\u30e9\u753b\u50cf":switch(z[e.target].option[Model.get("cursor").get("y")]){case "\u77f3\u5c71":Model.get("setting").set("charaImage","chara");break;case "\u307e\u3058\u3081":Model.get("setting").set("charaImage","chara1");break;case "\u623b\u308b":e.nest=0,Model.get("cursor").set("y",0)}break;case "\u623b\u308b":r("menu")}break;case "title":r("map");audio.play();break;case "battle":t({decide:!0});break;case "friendPokemonView":r("map");break;case "changePokemonView":C=!1,console.log(Model.get("cursor").num(),Model.get("cursor").get("x"),Model.get("cursor").get("y")),u=Model.get("cursor").num(),r("battle"),view.mes({message:"\u4ea4\u4ee3!"}),Model.get("cursor").set({maxX:1,maxY:1,x:0,y:0}),t({attack:[friend.at(u),enemy,enemy.get("technique")[4*Math.random()|0]]})}break;case "leave left":case "leave right":case "leave up":case "leave down":Model.get("chara").resetRun()}},routine:function(){for(var b in Model.get("isKeyPressed").attributes)0<Model.get("isKeyPressed").attributes[b]&&(view.keyAction(b),Model.get("isKeyPressed").increment(b));switch(k){case "title":view.display("title");break;case "map":view.display("map");view.display("chara");break;case "battle":view.display("battle");break;case "talk":view.display("map");view.display("chara");view.display("talk");break;case "menu":view.display("map");view.display("chara");view.display("menu");break;case "setting":view.display("map");view.display("chara");view.display("setting");break;case "friendPokemonView":view.display("friendPokemonView");break;case "changePokemonView":view.display("changePokemonView")}}}));I();J();document.getElementById("frontMap").width=document.getElementById("map").width=document.getElementById("villager").width=a.width*a.chipSize;document.getElementById("frontMap").height=document.getElementById("map").height=document.getElementById("villager").height=a.height*a.chipSize;setTimeout(function(){App.log("map drawing start");J();document.getElementById("screen").style.background="#000";App.log("map drawing end")},100);move=function(b,a,d,c){c=c||Model.get("chara");var g=c.get("x"),f=c.get("y");return g+b<=Model.get("world").get("width")-1&&0<=g+b&&f+a<=Model.get("world").get("height")-1&&0<=f+a&&Model.get("mapAttr").get(Model.get("mapData").get(f+a)[g+b]).isNotBarrier&&Model.get("mapAttr").get(Model.get("frontMapData").get(f+a)[g+b]).isNotBarrier&&-1==Model.get("Func").doesVillagerExist(g+b,f+a)?(d&&(c.incrementX(b),c.incrementY(a)),doesEncount&&P(),!0):!1};var g=function(b){App.log("keyUp "+b.keyCode);32==b.keyCode&&(b.preventDefault&&b.preventDefault(),Model.get("isKeyPressed").set("space",0));37<=b.keyCode&&40>=b.keyCode&&(b.preventDefault&&b.preventDefault(),Model.get("isKeyPressed").set({left:0,up:0,right:0,down:0}),37==b.keyCode&&view.keyAction("leave left"),38==b.keyCode&&view.keyAction("leave up"),39==b.keyCode&&view.keyAction("leave right"),40==b.keyCode&&view.keyAction("leave down"));77==b.keyCode&&(b.preventDefault&&b.preventDefault(),Model.get("isKeyPressed").set("m",0));69==b.keyCode&&(b.preventDefault&&b.preventDefault(),Model.get("isKeyPressed").set("e",0));68==b.keyCode&&(b.preventDefault&&b.preventDefault(),Model.get("isKeyPressed").set("d",0))},h=function(b){void 0!==b.keyCode&&(App.log("keyDown "+b.keyCode),32==b.keyCode&&(b.preventDefault&&b.preventDefault(),0==Model.get("isKeyPressed").get("space")&&(view.keyAction("space"),Model.get("isKeyPressed").get("space",-1))),37<=b.keyCode&&40>=b.keyCode&&(b.preventDefault&&b.preventDefault(),Model.get("isKeyPressed").set({left:0,up:0,right:0,down:0}),37==b.keyCode&&0===Model.get("isKeyPressed").get("left")?Model.get("isKeyPressed").increment("left"):38==b.keyCode&&0===Model.get("isKeyPressed").get("up")?Model.get("isKeyPressed").increment("up"):39==b.keyCode&&0===Model.get("isKeyPressed").get("right")?Model.get("isKeyPressed").increment("right"):40==b.keyCode&&0===Model.get("isKeyPressed").get("down")&&Model.get("isKeyPressed").increment("down")),68==b.keyCode&&(b.preventDefault&&b.preventDefault(),0===Model.get("isKeyPressed").get("d")&&Model.get("isKeyPressed").increment("d")),77==b.keyCode&&(b.preventDefault&&b.preventDefault(),0!=Model.get("isKeyPressed").get("m")||Model.get("isKeyPressed").get("m")||(view.keyAction("m"),Model.get("isKeyPressed").set("m",-1))),69==b.keyCode&&testMode&&(b.preventDefault&&b.preventDefault(),0==Model.get("isKeyPressed").get("e")&&(view.keyAction("e"),Model.get("isKeyPressed").set("e",-1))))};window.addEventListener("keyup",g,!1);window.addEventListener("keydown",h,!1);var q={pad_space:32,pad_left:37,pad_up:38,pad_right:39,pad_down:40,pad_D:68,pad_M:77};K&&(App.log("smart phone"),document.getElementsByTagName("body")[0].className="smartphone",document.getElementById("pad").style.display="block",window.addEventListener("touchstart",function(b){h({keyCode:q[b.target.id]})},!1),window.addEventListener("touchend",function(b){g({keyCode:q[b.target.id]})},!1),window.addEventListener("touchmove",function(b){for(var a=0;a<b.targetTouches.length;a++)if(b.targetTouches[a].target.id!=b.target.id){g({keyCode:q[b.target.id]});break}},!1));if(logMode){var f=new Date;setInterval(function(){logMode&&new Date-f>m[B].time&&("keyAction"==m[B].type&&(-1!=m[B].body.indexOf("keyDown")&&h({keyCode:parseInt(m[B].key)}),-1!=m[B].body.indexOf("keyUp")&&g({keyCode:parseInt(m[B].key)})),B++)},1)}setInterval(view.routine,IntervalTime);App.log("interval setted")}var m,Q,B=0;if(logMode){var E=new XMLHttpRequest;E.open("GET","js/log.txt",!0);E.send(null);E.onreadystatechange=function(){if(4==E.readyState){Q=E.responseText;m=Q.split("\n");for(var a=0;a<m.length;a++)m[a]={body:m[a].substring(0,m[a].lastIndexOf(":")),time:parseInt(m[a].substring(m[a].lastIndexOf(":")+1))},-1!=m[a].body.indexOf("loaded")&&(m[a].type="load"),-1!=m[a].body.indexOf("key")&&(m[a].type="keyAction",m[a].key=m[a].body.split(" ")[1]);O();E.onreadystatechange=void 0}}}App.noConsole();var K="ontouchstart"in window,y=document.getElementById("map").style,w=document.getElementById("frontMap").style,x=document.getElementById("villager").style;w.display="none";var k="title",u=0,c={chara:document.getElementById("chara").getContext("2d"),map:document.getElementById("map").getContext("2d"),frontMap:document.getElementById("frontMap").getContext("2d"),battle:document.getElementById("battle").getContext("2d"),menu:document.getElementById("menu").getContext("2d"),shop:document.getElementById("shop").getContext("2d"),mes:document.getElementById("mes").getContext("2d"),villager:document.getElementById("villager").getContext("2d"),clear:function(a){c[a].clearRect(0,0,c.width,c.height)},width:480,height:480},a={width:17,height:17,chipSize:32},r=function(){var a=k;return function(c){var h=[],e=[];switch(a){case "menu":h=["map","charaScreen","menu"];break;case "talk":h=["map","charaScreen","mes"];break;case "map":"talk"!=c&&(h=["map","charaScreen"]);break;case "title":h=["title"];break;case "battle":h=["mes","battle"];break;case "setting":h=["menu"];break;case "changePokemonView":h=["menu"]}switch(c){case "menu":k="menu";e=["map","charaScreen","menu"];break;case "talk":k="talk";e=["map","charaScreen","mes"];break;case "map":k="map";view.display("chara");e=["map","charaScreen"];view.charaDraw("none");break;case "title":k="title";e=["title"];break;case "battle":k="battle";e=["mes","battle"];break;case "setting":k="setting";e=["map","charaScreen","menu"];break;case "changePokemonView":k="changePokemonView",e=["menu"]}a=c;c=_.difference(h,e);h=_.difference(e,h);for(e=0;e<c.length;e++)view.hide(c[e]);for(e=0;e<h.length;e++)view.show(h[e])}}(),F=!1,P=function(a){Model.get("mapAttr").get(Model.get("mapData").get(Model.get("chara").get("y"))[Model.get("chara").get("x")]).isEncountable&&(a||0==(100*Math.random()|0))&&(App.log("encount "+a),r("battle"),void 0!==a&&"test"!=a?t({start:!0,monster:[a]}):t({start:!0,monster:Model.get("mapAttr").get(Model.get("mapData").get(Model.get("chara").get("y"))[Model.get("chara").get("x")]).livingMonster}))},t=function(d){d.start&&(App.log("battle start"),Model.get("cursor").set({maxX:1,maxY:1,x:0,y:0}),enemy=new Pokemon({name:d.monster[Math.random()*d.monster.length|0],lv:5}),enemy.set("img",new Image),enemy.get("img").src=enemy.get("src"),t({turnStart:!0}));d.turnStart&&(view.mes({message:enemy.get("name")+" \u304c\u73fe\u308c\u305f!\u3069\u3046\u3059\u308b?",dontWait:!0}),view.mes({message:"\u6226\u3046",x:-120,overwrite:!0,dontWait:!0}),view.mes({message:"\u30a2\u30a4\u30c6\u30e0",x:-60,overwrite:!0,dontWait:!0}),view.mes({message:"\u30dd\u30b1\u30e2\u30f3",x:-120,y:20,overwrite:!0,dontWait:!0}),view.mes({message:"\u9003\u3052\u308b",x:-60,y:20,overwrite:!0,dontWait:!0}),view.mes({message:">",x:-140+60*Model.get("cursor").get("x"),y:20*Model.get("cursor").get("y"),overwrite:!0,move:!0,dontWait:!0}),t({hpGauge:!0}));if(d.decide)switch(Model.get("cursor").num()){case 0:enemy.get("speed")<=friend.at(u).get("speed")?t({attack:[enemy,friend.at(u),friend.at(u).get("technique")[Model.get("cursor").get("x")+2*Model.get("cursor").get("y")]],next:function(){"battle"==k&&t({attack:[friend.at(u),enemy,enemy.get("technique")[4*Math.random()|0]]})}}):t({attack:[friend.at(u),enemy,enemy.get("technique")[4*Math.random()|0]],next:function(){"battle"==k&&t({attack:[enemy,friend.at(u),friend.at(u).get("technique")[Model.get("cursor").get("x")+2*Model.get("cursor").get("y")]]})}});break;case 1:view.mes({message:"\u30a2\u30a4\u30c6\u30e0!"});break;case 2:r("changePokemonView");Model.get("cursor").set({maxX:1,maxY:2,x:0,y:0});break;case 3:view.mes({message:"\u30d7\u30ec\u30a4\u30e4\u30fc\u306f\u9003\u3052\u3060\u3057\u305f!"}),1==(Math.random()*(enemy.get("speed")-friend.at(u).get("speed"))|0)?view.mes({message:"\u3057\u304b\u3057\u9003\u3052\u304d\u308c\u306a\u304b\u3063\u305f!",callback:function(){t({attack:[friend.at(u),enemy,enemy.get("technique")[4*Math.random()|0]]})}}):view.mes({message:"\u9003\u3052\u304d\u308c\u305f!",callback:function(){r("map");k="map"}})}else if(d.attack){var g=d.attack[0].get("hp"),e=new Technique(d.attack[2]),e=Math.floor((2*d.attack[1].get("lv")/5+2)*e.get("damage")*d.attack[1].attack()/d.attack[0].defence()/50+2)*(16*Math.random()|85)/100;d.attack[1].get("item")&&d.attack[1].get("item").effect&&(-1!=Model.get("Func").searchArray(d.attack[1].get("item").effect.split(","),"attack")?e=Math.floor(e*Model.get("Func").parseInt(d.attack[1].get("item").effect.split(",")[Model.get("Func").searchArray(d.attack[1].get("item").effect.split(","),"attack")].split(" ")[1])):-1!=Model.get("Func").searchArray(d.attack[1].get("item").effect.split(","),"all")&&(e=Math.floor(e*d.attack[1].get("attack")*Model.get("Func").parseInt(d.attack[1].get("item").effect.split(",")[Model.get("Func").searchArray(d.attack[1].get("item").effect.split(","),"all")].split(" ")[1]))));0>e&&(e=0);e=Math.floor(e);d.attack[0].set("hp",d.attack[0].get("hp")-e);view.mes({message:d.attack[1].get("name")+" \u306e\u653b\u6483!",callback:function(){t({hpGauge:!0})}});0>=d.attack[0].get("hp")?(view.mes({message:d.attack[0].get("name")+" \u306b"+(g-d.attack[0].get("hp"))+" \u306e\u30c0\u30e1\u30fc\u30b8!"}),view.mes({message:d.attack[0].get("name")+"\u3092\u5012\u3057\u305f!",callback:function(){d.attack[0].set("hp",d.attack[0].get("maxHp"));t({end:!0})}})):view.mes({message:d.attack[0].get("name")+" \u306b"+(g-d.attack[0].get("hp"))+" \u306e\u30c0\u30e1\u30fc\u30b8!",callback:function(){d.next?d.next():t({turnStart:!0})}})}else d.end?(App.log("battle end"),r("map"),k="map"):d.hpGauge&&(c.battle.beginPath(),c.battle.fillStyle="#FFF",c.battle.fillRect(0,a.realHeight-v.height-s.height,a.realWidth,a.realHeight),g=enemy.get("hp")/enemy.get("maxHp"),0>g&&(g=0),c.battle.fillStyle="#F00",c.battle.rect(0,a.realHeight-v.height-s.height,s.width,s.height),c.battle.fillRect(0,a.realHeight-v.height-s.height,s.width*g,s.height),g=friend.at(u).get("hp")/friend.at(u).get("maxHp"),0>g&&(g=0),c.battle.fillStyle="#0F0",c.battle.rect(a.realWidth-s.width,a.realHeight-v.height-s.height,s.width,s.height),c.battle.fillRect(a.realWidth-s.width,a.realHeight-v.height-s.height,s.width*g,s.height),c.battle.stroke(),c.battle.closePath())},U=function(){App.log("talk");var a=0,c=0,e=Model.get("chara").get("x"),k=Model.get("chara").get("y");switch(Model.get("chara").get("direction")){case "left":a=-1;break;case "front":c=1;break;case "right":a=1;break;case "back":c=-1}var f=Model.get("Func").doesVillagerExist(e+a,k+c);if(-1!=f){f=Model.get("Func").doesVillagerExist(e+a,k+c);switch(Model.get("chara").get("direction")){case "left":villagers.at(f).set("direction","right");break;case "right":villagers.at(f).set("direction","left");break;case "back":villagers.at(f).set("direction","front");break;case "front":villagers.at(f).set("direction","back")}view.clear("villager",villagers.at(f).get("x"),villagers.at(f).get("y"));view.drawVillager(f);villagers.at(f).talk()}else if(Model.get("frontMapData").get(k+c)&&5==Model.get("frontMapData").get(k+c)[e+a]&&-1!=Model.get("Func").doesVillagerExist(e+3*a,k+3*c)){f=Model.get("Func").doesVillagerExist(e+3*a,k+3*c);switch(Model.get("chara").get("direction")){case "left":villagers.at(f).set("direction","right");break;case "right":villagers.at(f).set("direction","left");break;case "back":villagers.at(f).set("direction","front");break;case "front":villagers.at(f).set("direction","back")}view.clear("villager",villagers.at(f).get("x"),villagers.at(f).get("y"));view.drawVillager(f);villagers.at(f).talk()}else view.mes({message:"\u3042\u3084\u3057\u3044\u3068\u3053\u308d\u306f\u7279\u306b\u306a\u306b\u3082\u306a\u3044\u3088\u3046\u3060"})},H=0,C=!1,D={width:170,height:200},e={width:200,height:250,nest:0},s={width:140,height:20},v={height:80},L=[{name:"\u56f3\u9451"},{name:"\u30ec\u30dd\u30fc\u30c8\u306b\u66f8\u304f"},{name:"\u8a2d\u5b9a"},{name:"\u624b\u6301\u3061\u306e\u30dd\u30b1\u30e2\u30f3"},{name:"\u30a2\u30a4\u30c6\u30e0"},{name:"\u30b2\u30fc\u30e0\u306b\u623b\u308b"},{name:"\u30bf\u30a4\u30c8\u30eb\u753b\u9762\u306b\u623b\u308b"},{name:"\u30bb\u30fc\u30d6\u30c7\u30fc\u30bf\u3092\u6d88\u3059"},{name:"App"}],z=[{name:"\u97f3\u91cf",option:["0%","50%","100%","\u623b\u308b"]},{name:"\u30ad\u30e3\u30e9\u753b\u50cf",option:["\u77f3\u5c71","\u307e\u3058\u3081","\u623b\u308b"]},{name:"\u623b\u308b"}];if(K){c.height=320;for(var R in c)document.getElementById(R)&&(document.getElementById(R).height=c.height);document.getElementById("screen").style.height=c.height+"px";a.height=12}a.realWidth=(a.width-2)*a.chipSize;a.realHeight=(a.height-2)*a.chipSize;var p={chara:new Image,chara1:new Image,black:new Image,"villager/farmer":new Image,"villager/blacksmith":new Image,"villager/butcher":new Image,"villager/citizen":new Image,"villager/curioshop":new Image,"villager/cure":new Image};App.log("images began loading");var M=0,S=function(){App.log(this.src.replace(/([\s\S]+?)([^\/]+?).(png|gif)/,"$2.$3")+" loaded");M++;document.getElementById("loading").innerText=100*(M/p.Length)+"%";M==p.Length&&(App.log("images loaded"),T(_))},A={left:-1*a.chipSize,top:-1*a.chipSize};logMode||O()},!1);